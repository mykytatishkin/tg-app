---
name: Giveaway + 3-week re-engagement
overview: "Два изменения: (1) при публикации нового розыгрыша — рассылка всем клиентам мастера с ссылкой на страницу розыгрышей; (2) для клиентов с последним визитом более 3 недель назад — персонализированное сообщение с кнопками «записаться» на подходящие по дню/времени слоты."
todos:
  - id: todo-1770049256080-1h733earm
    content: |+
      Мастеру в меню клиентов добавить кнопку "Отправить напоминалку про запись" и "Отправить подходящее расписание"

      Первая кнопка будет моментально отправлять сообщение которое идет после 14 дней

      А вторая кнопка будет моментально отправлять сообщение которое идет после 21 дня

    status: pending
  - id: todo-1770049331181-nmpjnnl94
    content: Добавить в профиль клиента ссылку на инсту (Интерфейс мастера)
    status: pending
  - id: todo-1770050319669-yhhjt93dt
    content: Добавить клиенту возможность подвязать инсту (указать профиль, не обязательно логиниться)
    status: pending
  - id: todo-1770050350877-xupl8mp79
    content: ""
    status: pending
isProject: false
---

# Оповещения о розыгрыше и ре-активация клиентов (3+ недель)

## 1. Оповещение клиентов о новом розыгрыше

**Триггер:** уведомление отправлять при **публикации** розыгрыша (статус переходит в `ACTIVE`), а не при создании в черновике — иначе по ссылке клиенты не увидят розыгрыш (в [giveaways.service.ts](backend/src/giveaways/giveaways.service.ts) клиентам отдаются только `ACTIVE`).

**Где:** [GiveawaysService.updateGiveaway](backend/src/giveaways/giveaways.service.ts) — после `update` проверить, что `dto.status === GiveawayStatus.ACTIVE` и что ранее статус был не ACTIVE; тогда вызвать рассылку.

**Кому:** все клиенты мастера с заполненным `telegramId` (у одного мастера — один розыгрыш, `giveaway.masterId`).

**Реализация:**

- В [GiveawaysModule](backend/src/giveaways/giveaways.module.ts) добавить `TypeOrmModule.forFeature([Client])`, в `GiveawaysService` внедрить `Repository<Client>`.
- Получить клиентов: `clientRepo.find({ where: { masterId: giveaway.masterId }, select: ['telegramId'] })`, отфильтровать по `telegramId`.
- Текст сообщения: кратко о новом розыгрыше + призыв участвовать. Ссылка: `MINI_APP_URL + '/giveaways'` (уже есть в [client-reminders.service.ts](backend/src/crm/client-reminders.service.ts) через `ConfigService.get('MINI_APP_URL')`).
- Отправка: существующий `BotService.sendMessageWithWebAppButton(chatId, text, 'Участвовать в розыгрыше', giveawaysUrl)` в цикле (с дедупликацией по `telegramId` и игнорированием ошибок, как в рассылке победителям).

**Альтернатива:** если нужно слать при создании (даже из черновика), то вызывать рассылку в `createGiveaway` и не привязываться к ACTIVE; тогда в сообщении можно писать «скоро стартует розыгрыш» и ту же ссылку на `/giveaways`.

---

## 2. Ре-активация клиентов 3+ недель без визита (слоты по дню/времени)

**Цель:** для клиентов, у которых последний приём (DONE) был **больше 3 недель** назад, посчитать, в какие дни недели и в какое время они раньше записывались, найти слоты мастера в эти дни/время и отправить сообщение с кнопками «записаться» на конкретные даты.

**Где:** расширить [ClientRemindersService](backend/src/crm/client-reminders.service.ts) (уже есть логика «2 недели», клиенты, последний визит, бот). Добавить вторую ветку: «если последний визит > 21 день» — умное напоминание со слот-кнопками; иначе при 14–21 день оставить текущее простое напоминание.

**Данные:**

- **Клиенты 3+ недель:** как сейчас — последний DONE по `clientId`, но порог заменить на 21 день для этой ветки (оставить 14 дней для простого напоминания: 14–21 день — одно сообщение, 21+ — другое с кнопками).
- **История клиента:** все DONE-приёмы клиента, из них взять `date` (день недели 0–6) и `startTime` (время суток — например утро 6–12, день 12–18, вечер 18–22).
- **Слоты мастера:** слоты на ближайшие N дней (например 14) из [AvailabilitySlot](backend/src/crm/entities/availability-slot.entity.ts) по `masterId`, `date >= today`, `isAvailable: true`, отсортировать по date, startTime.

**Сопоставление:** для каждого такого клиента:

1. Собрать по истории множества: дни недели (0–6) и интервалы времени (например по часам или по трём блокам: утро/день/вечер).
2. Выбрать слоты мастера, у которых день недели в «любимых» или время начала в «любимом» интервале.
3. Взять первые 3–5 уникальных слотов (по дате + startTime), сформировать для каждого подпись вида «Среда 12 фев, 10:00» и URL: `MINI_APP_URL + '/appointments/book?date=YYYY-MM-DD&masterId=...'`.

**Отправка:** одно сообщение с несколькими кнопками. В [BotService](backend/src/bot/bot.service.ts) сейчас есть только одна Web App кнопка — `sendMessageWithWebAppButton`. Нужен новый метод, например `sendMessageWithWebAppButtons(chatId, text, buttons: { label: string, url: string }[])`, формирующий `reply_markup.inline_keyboard` с несколькими кнопками `{ text, web_app: { url } }` (по 1–2 в ряд, чтобы не перегружать интерфейс). Вызвать его из `ClientRemindersService` для клиентов 3+ недель с массивом подготовленных кнопок. Если подходящих слотов нет — отправить обычное напоминание с одной кнопкой «Записаться» на `/appointments/book` (как сейчас для 2 недель).

**Зависимости в CRM:** [CrmModule](backend/src/crm/crm.module.ts) уже подключает `AvailabilitySlot`; в `ClientRemindersService` нужно внедрить `Repository<AvailabilitySlot>` (и при необходимости `Repository<Service>` для будущего расширения, пока можно обойтись без него — слоты по дате/времени не требуют выбора услуги для подсказки).

**Фронт — предзаполнение даты/мастера по ссылке:** сейчас [AppointmentsBook.vue](frontend/src/views/AppointmentsBook.vue) не читает query. Нужно при открытии страницы считывать `route.query.date` и `route.query.masterId`: если есть `date` — после загрузки слотов выделить/выбрать первый слот с этой датой (и при наличии — подходящим временем); если есть `masterId` — сразу выставить выбранного мастера и загрузить услуги/слоты. Тогда кнопки из бота будут вести на запись с уже подобранной датой (и мастером).

**Уточнение по «дню недели или времени»:** в сообщении можно сформулировать кратко: «Раньше вы часто записывались по средам и в утренние часы. Вот подходящие слоты» и показать кнопки с конкретными датами/временами.

---

## Порядок внедрения

1. **Бот:** добавить в [bot.service.ts](backend/src/bot/bot.service.ts) метод `sendMessageWithWebAppButtons(chatId, text, buttons)`.
2. **Розыгрыш:** в [giveaways.module.ts](backend/src/giveaways/giveaways.module.ts) добавить `Client`, в [giveaways.service.ts](backend/src/giveaways/giveaways.service.ts) — рассылку при переходе в ACTIVE в `updateGiveaway` (и при необходимости при создании, если решите слать и из черновика).
3. **Фронт:** в [AppointmentsBook.vue](frontend/src/views/AppointmentsBook.vue) — чтение `query.date` и `query.masterId`, предвыбор мастера и при загрузке слотов — выделение/выбор слота по дате.
4. **Напоминания 3+ недель:** в [client-reminders.service.ts](backend/src/crm/client-reminders.service.ts) — порог 21 день, выборка истории приёмов (день недели + время), запрос слотов мастера, сопоставление, формирование кнопок и вызов `sendMessageWithWebAppButtons`; при отсутствии слотов — fallback на одно кнопку «Записаться».
5. Согласовать тексты сообщений (розыгрыш и ре-активация) и при необходимости вынести их в константы/конфиг.

После этого: при публикации розыгрыша все клиенты мастера получат ссылку на страницу розыгрышей, а клиенты без визита 3+ недель — персонализированное предложение с кнопками на подходящие по дню/времени слоты с переходом на запись с предзаполненной датой (и мастером).